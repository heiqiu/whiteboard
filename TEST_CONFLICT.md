# 冲突检测功能测试指南

## 🎯 功能说明

当前实现的是**类似 Git 的保存前冲突检测**机制：
- 用户编辑时不会自动同步
- 点击保存时才检查远程是否有更新
- 如果有更新（其他用户已保存），显示冲突对话框
- 用户选择如何处理冲突

## ✅ 正常流程（无冲突）

```
用户 A 操作流程：
1. 打开白板 → 加载数据（版本 v5）
2. 编辑便签（本地版本仍是 v5）
3. 点击保存
   → 检查远程版本：v5
   → 本地版本：v5
   → 无冲突 ✅
   → 直接保存为 v6
```

**这是正确的行为！** 因为在编辑期间没有其他人保存，所以不应该有冲突。

## ⚠️ 冲突场景（有冲突）

要测试冲突检测，需要**两个用户同时操作**：

### 场景 1：两个用户同时编辑

```
时间线：
┌─────────────────────────────────────┐
│ t1: 用户 A 打开白板（加载 v5）      │
│ t2: 用户 B 打开白板（加载 v5）      │
│ t3: 用户 A 编辑便签 1               │
│ t4: 用户 B 编辑便签 2               │
│ t5: 用户 B 点击保存                 │
│     → 检查：远程 v5，本地 v5        │
│     → 无冲突，保存为 v6 ✅          │
│ t6: 用户 A 点击保存                 │
│     → 检查：远程 v6，本地 v5        │
│     → 有冲突！❌                     │
│     → 显示冲突对话框                │
└─────────────────────────────────────┘
```

### 场景 2：编辑同一个便签

```
初始状态：便签 3 内容 = "原始内容"

用户 A：
1. 打开白板（v5）
2. 修改便签 3 = "用户 A 的修改"
3. 暂不保存

用户 B：
1. 打开白板（v5）
2. 修改便签 3 = "用户 B 的修改"
3. 点击保存 → 成功（v6）

用户 A：
4. 点击保存
   → 检测到冲突 ⚠️
   → 显示：便签 3 在两端都被修改
   → 选择：
      - 自动合并 → 使用远程的（用户 B 的修改）
      - 使用远程 → 放弃本地修改
      - 强制本地 → 覆盖用户 B 的修改
```

## 🧪 测试步骤

### 方法 1：使用两个浏览器

1. **浏览器 1（Chrome）**：
   ```
   - 打开白板应用
   - F12 打开控制台（查看日志）
   - 创建一个便签 "便签 A"
   - 不要保存
   ```

2. **浏览器 2（Edge/Firefox）**：
   ```
   - 打开同一个白板应用
   - F12 打开控制台
   - 创建一个便签 "便签 B"
   - 点击保存 ✅
   ```

3. **回到浏览器 1**：
   ```
   - 点击保存
   - 应该看到冲突对话框 ⚠️
   - 控制台输出：
     [冲突检查] 开始检查，本地版本: 5
     [冲突检查] 远程版本: 6 是否有更新: true
     [冲突检测] 发现冲突！本地 v5 vs 远程 v6
   ```

### 方法 2：使用无痕模式

1. 普通窗口打开白板
2. 无痕窗口打开白板
3. 按照方法 1 的步骤测试

## 📊 控制台日志说明

### 无冲突的日志：
```
开始检查冲突，本地版本: 5
[冲突检查] 开始检查，本地版本: 5
[冲突检查] 远程版本: 5 是否有更新: false
[冲突检测] 无冲突，可以直接保存
冲突检查结果: { hasConflict: false, ... }
白板数据已保存: Saved successfully
```

### 有冲突的日志：
```
开始检查冲突，本地版本: 5
[冲突检查] 开始检查，本地版本: 5
[冲突检查] 远程版本: 6 是否有更新: true
[冲突检测] 发现冲突！本地 v5 vs 远程 v6
冲突检查结果: { hasConflict: true, remoteVersion: 6, ... }
```

## 🔍 为什么单用户不会有冲突？

这是**设计正确**的行为：

```
单用户场景：
用户 A: 加载 v5 → 编辑 → 保存
        ↓
        检查：远程 v5，本地 v5
        ↓
        无冲突 ✅（正确！）
        ↓
        保存为 v6
```

只有当**另一个用户在你编辑期间保存了数据**，才会产生冲突：

```
多用户场景：
用户 A: 加载 v5 → 编辑中...
用户 B: 加载 v5 → 编辑 → 保存为 v6 ✅
用户 A: 继续编辑 → 保存
        ↓
        检查：远程 v6，本地 v5
        ↓
        有冲突 ⚠️（正确！）
        ↓
        显示对话框
```

## 💡 验证要点

1. ✅ **版本号显示**：工具栏应显示当前版本号
2. ✅ **检查冲突状态**：保存时按钮显示"检查冲突..."
3. ✅ **冲突对话框**：有冲突时弹出对话框
4. ✅ **合并策略**：支持自动合并/使用远程/强制本地
5. ✅ **控制台日志**：查看详细的冲突检测日志

## 🎯 总结

- **不是 Bug**：单用户不会有冲突是正确的
- **真正的冲突**：需要多个用户同时编辑才会触发
- **类似 Git**：就像 `git push` 前会检查远程是否有更新
- **用户友好**：明确显示冲突详情，由用户决定如何处理

当前实现完全符合类 Git 工作流的设计目标！✅
